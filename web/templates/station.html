{% extends 'template.html' %}
{% block content %}
    <div style="height:400px;overflow:hidden">
        <div id="map"></div>
    </div>
    <div style="overflow:auto">
        <table id='table' class='table table-hover table-bordered'>
            <thead>
            <tr>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
{% endblock %}
<script>
    {% block script %}
        $("a:contains('车站')").addClass('active');
        var map_div = $('#map');
        map_div.height(map_div.parent().height() + hidden);
        var map = echarts.init(map_div.get(0));
        var station = '{{ data.cn }}';
        $('#info').text('');
        set_map('');
        $.post('{% url 'data' %}', {'type': 'station', 'station': station}, function (data) {
            set_timetable(data[0]);
            set_map(data[1])
        });
        function set_timetable(data) {
            var th = ['车次', '始发', '终到', '到达', '离开', '停留'];
            $.each(th, function () {
                $('#table').find('thead').find('tr').append($('<td>').text(this));
            });
            $.each(data, function (n, line) {
                var tr = $('<tr>');
                $.each(line, function (n, txt) {
                    if (n < 3) {
                        td = $('<td>').append($('<a>').attr('href', ['{% url 'line' '*' %}', '{% url 'station' '*' %}', '{% url 'station' '*' %}'][n].replace('*', txt)).text(txt))
                    }
                    else if ($.inArray(txt, ['始', '终']) > -1) {
                        td = $('<td>').append($('<span>').attr('class', 'badge badge-pill badge-' + {
                            '始': 'success',
                            '终': 'warning'
                        }[txt]).text(txt))
                    }
                    else {
                        td = $('<td>').text(txt);
                    }
                    tr.append(td)
                });
                $('#table').find('tbody').append(tr);
            });
        }
        function set_map(data) {
            var option = {};
            if (!data) {
                option = {
                    title: {
                        text: station,
                        subtext: '{{data.province}} {{data.city}} {{data.county}}',
                        left: 'center'
                    },
                    series: []
                };
                map.showLoading()
            }
            else {
                var center_zoom = location(data);
                option = {
                    bmap: {
                        center: center_zoom[0],
                        zoom: center_zoom[1],
                        roam: true,
                        mapStyle: mapStyle_white
                    },
                    series: {
                        name: '车站',
                        coordinateSystem: 'bmap',
                        type: 'effectScatter',
                        symbolSize: center_zoom[1],
                        showEffectOn: 'render',
                        rippleEffect: {
                            brushType: 'stroke'
                        },
                        data: data,
                        hoverAnimation: true,
                        {#                        label: {#}
                        {#                            normal: {#}
                        {#                                formatter: function (info) {#}
                        {#                                    return info.data[5]#}
                        {#                                },#}
                        {#                                show: true,#}
                        {#                                position:'top'#}
                        {#                            }#}
                        {#                        },#}
                        itemStyle: {
                            normal: {
                                color: 'red',
                                shadowBlur: center_zoom[1],
                                shadowColor: 'white'
                            }
                        }
                    }
                };
                map.hideLoading()
            }
            map.setOption(option);
        }
    {% endblock %}
</script>