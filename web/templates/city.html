{% extends 'template.html' %}
{% block content %}
    <div id="treemap" class="echarts"></div>
{% endblock %}
<script>
    {% block script %}
        $("a:contains('城市')").addClass('active');
        $('.echarts').height($(window).height() / 2);
        get_city('{{ city }}');
        loading.show();
        function get_city(city) {
            $.post('{% url 'data' %}', {'type': 'city', 'city': city}, function (res) {
                loading.hide();
                [level, data] = res;
                treemap('treemap', level, data);
            })
        }
        function treemap(div, level, data) {
            var option = {
                tooltip: {
                    formatter: function (paramer) {
                        if (paramer.treePathInfo.length < 5) {
                            return paramer.name + '</br>'
                                + '车站 ' + paramer.value + ' 座'
                        }
                        else {
                            return paramer.name + '站</br>'
                                + '点击跳转'
                        }
                    }
                },
                series: [{
                    name: '全国',
                    type: 'treemap',
                    label: {
                        normal: {
                            show: true,
                            formatter: '{b}'
                        }
                    },
                    width: '100%',
                    height: '100%',
                    itemStyle: {
                        normal: {
                            borderColor: 'rgba(255,255,255,0)',
                            borderWidth: 1
                        }
                    },
                    drillDownIcon: '',
                    nodeClick: 'link',
                    slient: true,
                    data: conversion(level, data, 0)
                }]
            };
            var charts = echarts.init(document.getElementById(div));
            charts.on('click', function (params) {
                if (params.treePathInfo.length < 5) {
                    var city = [];
                    $.each(params.treePathInfo.slice(1), function () {
                        city.push(this.name)
                    });
                    if (city.length > 0) {
                        city = city.join('-')
                    }
                    else {
                        city = 'index'
                    }
                    get_city(city);
                }
                else {
                    window.open('{% url "station" "*" %}'.replace('*', params.treePathInfo[4].name));
                }
            });
            charts.setOption(option);
        }

        function conversion(level, data_old, n) {
            var data_new = [];
            $.each(data_old, function (k, v) {
                var item = '';
                if (n < level) {
                    item = {'name': k, 'children': conversion(level, v, n + 1)}
                }
                else {
                    item = {
                        'name': k,
                        'value': v
                    }
                }
                data_new.push(item)
            });
            return data_new
        }
    {% endblock %}
</script>